name: Prisma Cloud IaC Scan

on:
  push:
    branches:
      - main

jobs:
  prisma_scan:
    runs-on: ubuntu-latest
    env:
      PRISMA_URL: ${{ secrets.PRISMA_URL }}
      PRISMA_ACCESS_KEY: ${{ secrets.PRISMA_ACCESS_KEY }}
      PRISMA_SECRET_KEY: ${{ secrets.PRISMA_SECRET_KEY }}

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Instalar TwistCLI
        run: |
          echo "üîÑ Baixando TwistCLI da console Prisma Cloud..."
          echo "‚û°Ô∏è  URL: ${PRISMA_URL}"
          curl -L -o twistcli "${PRISMA_URL}/api/v1/util/twistcli" || {
            echo "‚ùå Falha ao baixar o TwistCLI. Verifique o PRISMA_URL!"
            exit 1
          }
          chmod +x twistcli
          sudo mv twistcli /usr/local/bin/twistcli

      - name: Executar scan IaC
        run: |
          echo "üöÄ Executando scan IaC com TwistCLI..."
          twistcli coderepo scan . \
            --ci-keys \
            --address "${PRISMA_URL}" \
            --user "${PRISMA_ACCESS_KEY}" \
            --password "${PRISMA_SECRET_KEY}" \
            --details \
            --publish

      - name: Salvar relat√≥rio JSON
        if: always()
        run: |
          mkdir -p results
          twistcli coderepo scan . \
            --ci-keys \
            --address "${PRISMA_URL}" \
            --user "${PRISMA_ACCESS_KEY}" \
            --password "${PRISMA_SECRET_KEY}" \
            --output-file results/scan.json || true
        continue-on-error: true

      - name: Upload do relat√≥rio
        uses: actions/upload-artifact@v4
        with:
          name: prisma-scan-report
          path: results/scan.json

