name: Prisma Cloud IaC Scan

on:
  push:
    branches:
      - main

jobs:
  prisma_scan:
    runs-on: ubuntu-latest
    env:
      PRISMA_API_URL: ${{ secrets.PRISMA_API_URL }}
      PRISMA_ACCESS_KEY: ${{ secrets.PRISMA_ACCESS_KEY }}
      PRISMA_SECRET_KEY: ${{ secrets.PRISMA_SECRET_KEY }}

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Instalar TwistCLI
        run: |
          echo "Baixando TwistCLI da console Prisma Cloud..."
          echo "Usando URL: ${PRISMA_API_URL}"
          curl -L -o twistcli "${PRISMA_API_URL}/api/v1/util/twistcli"
          chmod +x twistcli
          sudo mv twistcli /usr/local/bin/twistcli

      - name: Executar scan IaC
        run: |
          echo "Executando scan IaC com TwistCLI (autenticação por Access Key)..."
          twistcli coderepo scan . \
            --ci-keys \
            --address "${PRISMA_API_URL}" \
            --user "${PRISMA_ACCESS_KEY}" \
            --password "${PRISMA_SECRET_KEY}" \
            --details \
            --publish

