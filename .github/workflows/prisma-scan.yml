name: Prisma Cloud IaC Scan

on:
  push:
    branches:
      - main

jobs:
  prisma_scan:
    runs-on: ubuntu-latest
    env:
      PRISMA_API_URL: ${{ secrets.PRISMA_API_URL }}
      PRISMA_ACCESS_KEY: ${{ secrets.PRISMA_ACCESS_KEY }}
      PRISMA_SECRET_KEY: ${{ secrets.PRISMA_SECRET_KEY }}

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Instalar TwistCLI
        run: |
          echo "ðŸ”„ Baixando TwistCLI da console Prisma Cloud (SaaS)..."
          curl -L -o twistcli "${PRISMA_API_URL}/api/v1/util/twistcli"
          chmod +x twistcli
          sudo mv twistcli /usr/local/bin/twistcli

      - name: Executar scan IaC via API Prisma Cloud
        run: |
          echo "ðŸš€ Executando scan IaC via Prisma Cloud SaaS..."
          twistcli coderepo scan . \
            --ci-keys \
            --address "${PRISMA_API_URL}" \
            --user "${PRISMA_ACCESS_KEY}" \
            --password "${PRISMA_SECRET_KEY}" \
            --details \
            --publish \
            --output-file results/scan.json

      - name: Upload do relatÃ³rio
        uses: actions/upload-artifact@v4
        with:
          name: prisma-scan-report
          path: results/scan.json

