name: Prisma Cloud IaC Scan

on:
  push:
    branches:
      - main

jobs:
  prisma_scan:
    runs-on: ubuntu-latest
    env:
      PRISMA_URL: ${{ secrets.PRISMA_URL }}
      PRISMA_USER: ${{ secrets.PRISMA_USER }}
      PRISMA_PASS: ${{ secrets.PRISMA_PASS }}

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Instalar TwistCLI
        run: |
          echo "Baixando TwistCLI da console Prisma Cloud..."
          echo "Usando URL: ${PRISMA_URL}"
          curl -L -o twistcli "${PRISMA_URL}/api/v1/util/twistcli"
          chmod +x twistcli
          sudo mv twistcli /usr/local/bin/twistcli

      - name: Executar scan IaC
        run: |
          echo "Executando scan IaC com TwistCLI..."
          twistcli coderepo scan . \
            --address "${PRISMA_URL}" \
            --user "${PRISMA_USER}" \
            --password "${PRISMA_PASS}" \
            --details \
            --publish

